{"version":3,"sources":["../../source/library/log.js"],"names":["Configuration","Is","Pino","LogDestination","LogHandler","LogParameter","LogAttachedError","LogDetachedError","LogOptionNotSupportedError","Process","process","Log","constructor","parameter","userDestination","userOption","getConstructorParameter","destination","option","getOption","defaultOption","pinoDestination","pinoOption","_pinoLog","_createPinoLog","_destination","_option","createDestination","getLevelName","levelNumber","levels","labels","trace","debug","info","warn","error","fatal","attach","handleExit","handleKillSignal","windows","handleRotate","_attachOption","on","__onExit","onImmediate","immediateLog","detach","forEach","signal","count","listenerCount","exit","rotate","off","createProxy","object","Proxy","immediateFn","final","pinoLog","immediateParameter","not","null"],"mappings":"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","sourcesContent":["import { Configuration } from '@virtualpatterns/mablung-configuration'\nimport { Is } from '@virtualpatterns/mablung-is'\nimport Pino from 'pino'\n\nimport { LogDestination } from './log-destination.js'\nimport { LogHandler } from './log-handler.js'\nimport { LogParameter } from './log-parameter.js'\n\nimport { LogAttachedError } from './error/log-attached-error.js'\nimport { LogDetachedError } from './error/log-detached-error.js'\nimport { LogOptionNotSupportedError } from './error/log-option-not-supported-error.js'\n\nconst Process = process\n\nclass Log {\n\n  constructor(...parameter) {\n\n    let [ userDestination, userOption ] = LogParameter.getConstructorParameter(this, ...parameter)\n  \n    let destination = userDestination\n    let option = Configuration.getOption(this.defaultOption, userOption)\n\n    let pinoDestination = destination instanceof LogDestination ? destination.pinoDestination : destination\n    let pinoOption = option\n\n    this._pinoLog = this._createPinoLog(pinoDestination, pinoOption)\n\n    this._destination = destination\n    this._option = option\n\n  }\n\n  _createPinoLog(destination, option) {\n    return Pino(option, destination)\n  }\n\n  createDestination(...parameter) {\n    return new LogDestination(...parameter)\n  }\n\n  /* c8 ignore next 3 */\n  get destination() {\n    return this._destination\n  }\n\n  get defaultOption() {\n    return {\n      'level': 'info',\n      'nestedKey': 'data'\n    }\n  }\n\n  /* c8 ignore next 3 */\n  get option() {\n    return this._option\n  }\n\n  getLevelName(levelNumber) {\n    return this._pinoLog.levels.labels[levelNumber]\n  }\n\n  trace(...parameter) {\n    return this._pinoLog.trace(...parameter)\n  }\n\n  debug(...parameter) {\n    return this._pinoLog.debug(...parameter)\n  }\n\n  info(...parameter) {\n    return this._pinoLog.info(...parameter)\n  }\n\n  warn(...parameter) {\n    return this._pinoLog.warn(...parameter)\n  }\n\n  error(...parameter) {\n    return this._pinoLog.error(...parameter)\n  }\n\n  fatal(...parameter) {\n    return this._pinoLog.fatal(...parameter)\n  }\n\n  attach({ handleExit = true, handleKillSignal = Is.windows() ? false : [ 'SIGINT', 'SIGTERM' ], handleRotate = Is.windows() ? false : [ 'SIGHUP' ] } = {}) {\n    this.trace({ handleExit, handleKillSignal, handleRotate }, 'Log.attach(option)')\n\n    if (this._attachOption) {\n      throw new LogAttachedError()\n    } else {\n\n      try { \n\n        if (handleExit) {\n\n          Process.on('exit', this.__onExit = this.onImmediate((immediateLog) => {\n            immediateLog.trace('Process.on(\\'exit\\', this.__onExit = this.onImmediate((immediateLog) => { ... }))')\n  \n            try {\n              this.detach()\n            /* c8 ignore next 3 */\n            } catch (error) {\n              immediateLog.error(error)\n            }\n  \n          }))\n  \n        }\n  \n        if (handleKillSignal) {\n    \n          if (Is.windows()) {\n            throw new LogOptionNotSupportedError('handleKillSignal')\n          } else {\n            \n            handleKillSignal.forEach((signal) => {\n              Process.on(signal, this[`__on${signal}`] = this.onImmediate((immediateLog) => {\n                immediateLog.trace(`Process.on('${signal}', this.__on${signal} = this.onImmediate((immediateLog) => { ... }))`)\n  \n                try {\n                  this.detach()\n                /* c8 ignore next 3 */\n                } catch (error) {\n                  immediateLog.error(error)\n                }\n        \n                let count = Process.listenerCount(signal)\n  \n                /* c8 ignore next 5 */\n                if (count <= 0) {\n                  Process.exit()\n                } else {\n                  immediateLog.trace(`Process.listenerCount('${signal}') returned ${count}`)\n                }\n  \n              }))\n            })\n  \n          }\n  \n        }\n  \n        if (handleRotate) {\n    \n          if (Is.windows()) {\n            throw new LogOptionNotSupportedError('handleRotate')\n          } else {\n              \n            handleRotate.forEach((signal) => {\n              Process.on(signal, this[`__on${signal}`] = () => {\n                this.trace(`Process.on('${signal}', this.__on${signal} = () => { ... })`)\n  \n                try {\n                  this.rotate()\n                /* c8 ignore next 3 */\n                } catch (error) {\n                  this.error(error)\n                }\n  \n              })\n            })\n  \n          }\n  \n        }\n          \n      } catch (error) {\n\n        if (handleExit && \n            this.__onExit) {\n          Process.off('exit', this.__onExit)\n          delete this.__onExit\n        }\n\n        if (handleKillSignal) {\n\n          handleKillSignal.forEach((signal) => {\n            if (this[`__on${signal}`]) {\n              Process.off(signal, this[`__on${signal}`])\n              delete this[`__on${signal}`]\n            }\n          })\n\n        }\n\n        if (handleRotate) {\n\n          handleRotate.forEach((signal) => {\n            if (this[`__on${signal}`]) {\n              Process.off(signal, this[`__on${signal}`])\n              delete this[`__on${signal}`]\n            }\n          })\n\n        }\n\n        throw error\n\n      }\n\n      this._attachOption = { handleExit, handleKillSignal, handleRotate }\n\n    }\n\n  }\n\n  detach() {\n    this.trace('Log.detach()')\n\n    if (this._attachOption) {\n\n      let { handleExit, handleKillSignal, handleRotate } = this._attachOption\n\n      if (handleExit && \n          this.__onExit) {\n        Process.off('exit', this.__onExit)\n        delete this.__onExit\n      }\n\n      if (handleKillSignal) {\n  \n        handleKillSignal.forEach((signal) => {\n          if (this[`__on${signal}`]) {\n            Process.off(signal, this[`__on${signal}`])\n            delete this[`__on${signal}`]\n          }\n        })\n\n      }\n\n      if (handleRotate) {\n\n        handleRotate.forEach((signal) => {\n          if (this[`__on${signal}`]) {\n            Process.off(signal, this[`__on${signal}`])\n            delete this[`__on${signal}`]\n          }\n        })\n\n      }\n\n      delete this._attachOption\n        \n    } else {\n      throw new LogDetachedError()\n    }\n\n  }\n\n  rotate() {\n    this._destination.rotate()\n  }\n\n  createProxy(object) {\n    return new Proxy(object, new LogHandler(this))\n  }\n\n  onImmediate(immediateFn) {\n\n    return Pino.final(this._pinoLog, (error, pinoLog, ...parameter) => {\n\n      let immediateLog = null\n      immediateLog = new this.constructor(this._destination, this._option)\n      immediateLog._pinoLog = pinoLog\n\n      let immediateParameter = Is.not.null(error) ? [error, ...parameter] : parameter\n\n      immediateFn(immediateLog, ...immediateParameter)\n\n    })\n\n  }\n\n}\n\nexport { Log }\n"],"file":"log.js"}