{"version":3,"sources":["../../source/library/log-handler.js"],"names":["Luxon","Is","Utilities","DateTime","Process","process","EXCLUDE_PROPERTY_NAME","NANOSECONDS_PER_SECOND","LogHandler","constructor","log","_log","construct","target","parameter","className","name","formatParameterFn","_formatConstructorParameter","bind","_formatParameter","parameterAsObject","parameterAsString","trace","start","hrtime","returnValue","Reflect","duration","_getDuration","Proxy","get","propertyName","receiver","function","includes","apply","self","_applyIn","error","_applyException","Promise","then","_returnValue","_applyOut","methodName","_getFormattedIn","null","message","stack","undefined","returnValueAsObject","returnValueAsString","_getFormattedOut","emptyString","formatReturnValueFn","_formatReturnValue","seconds","nanoseconds","parameterAsArray","keyPrefix","index","key","map","value","primitive","_formatPrimitive","date","_formatDateTime","regexp","toString","join","inspect","fromJSDate","toFormat"],"mappings":"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","sourcesContent":["import Luxon from 'luxon'\nimport Is from '@pwn/is'\nimport Utilities from 'util'\n\nconst { DateTime } = Luxon\nconst Process = process\n\nconst EXCLUDE_PROPERTY_NAME = [ 'constructor', '_formatConstructorParameter', '_formatParameter', '_formatReturnValue' ]\nconst NANOSECONDS_PER_SECOND = 1000000000\n\nclass LogHandler {\n\n  constructor(log) {\n    this._log = log\n  }\n\n  construct(target, parameter) {\n\n    let className = target.name\n\n    let formatParameterFn = target._formatConstructorParameter ? target._formatConstructorParameter.bind(target, ...parameter) : this._formatParameter.bind(this, parameter)\n    let [ parameterAsObject, parameterAsString ] = formatParameterFn()\n\n    this._log.trace(parameterAsObject, `> new ${className}(${parameterAsString})`)\n\n    let start = Process.hrtime()\n    let returnValue = Reflect.construct(target, parameter)\n    let duration = this._getDuration(Process.hrtime(start))\n\n    this._log.trace({ ...parameterAsObject, duration }, `< new ${className}(${parameterAsString})`)\n\n    return new Proxy(returnValue, this)\n\n  }\n\n  get(target, propertyName, receiver) {\n\n    let returnValue = Reflect.get(target, propertyName, receiver)\n\n    // if (Is.primitive(returnValue) ||\n    //     Is.not.symbol(propertyName) &&\n    //     ( propertyName === FORMAT_CONSTRUCTOR_PARAMETER || \n    //       propertyName === FORMAT_PARAMETER || \n    //       propertyName === FORMAT_RETURN_VALUE)) {\n    //   return returnValue\n    // } else {\n    //   // this._log.trace(`LogHandler.get(target, ${this._formatPrimitive(propertyName)}, receiver)`)\n    //   return new Proxy(returnValue, this)\n    // }\n\n    if (Is.function(returnValue) && \n        !EXCLUDE_PROPERTY_NAME.includes(propertyName)) {\n      // this._log.trace(`LogHandler.get(target, ${this._formatPrimitive(propertyName)}, receiver)`)\n      return new Proxy(returnValue, this)\n    } else {\n      return returnValue\n    }\n\n  }\n\n  apply(target, self, parameter) {\n\n    this._applyIn(target, self, parameter)\n\n    let start = null\n    let returnValue = null\n    let duration = null\n\n    try {\n      start = Process.hrtime()\n      returnValue = Reflect.apply(target, self, parameter)\n      duration = this._getDuration(Process.hrtime(start))\n    } catch(error) {\n      this._applyException(target, self, parameter, error)\n      throw error\n    }\n\n    if (returnValue instanceof Promise) {\n\n      returnValue = returnValue.then((_returnValue) => {\n\n        duration = this._getDuration(Process.hrtime(start))\n        this._applyOut(target, self, parameter, duration, _returnValue)\n\n        // return Is.primitive(_returnValue) || _returnValue instanceof Promise ? _returnValue : new Proxy(_returnValue, this)\n        // return _returnValue\n\n        if (Is.function(_returnValue)) {\n          return new Proxy(_returnValue, this)\n        } else {\n          return _returnValue\n        }\n\n      })\n\n    } else {\n      this._applyOut(target, self, parameter, duration, returnValue)\n    }\n\n    // return Is.primitive(returnValue) || returnValue instanceof Promise ? returnValue : new Proxy(returnValue, this)\n    // return returnValue\n\n    if (Is.function(returnValue)) {\n      return new Proxy(returnValue, this)\n    } else {\n      return returnValue\n    }\n\n  }\n\n  _applyIn(target, self, parameter) {\n    let [ className, methodName, parameterAsObject, parameterAsString ] = this._getFormattedIn(target, self, parameter)\n    this._log.trace(parameterAsObject, `> ${Is.null(className) ? '' : `${className}.`}${methodName}(${parameterAsString})`)\n  }\n\n  _applyException(target, self, parameter, error) {\n    // when using nestedKey, pino does not seem to add the message and stack to the nested key\n    // this._log.error(error)\n    this._log.error({ 'message': error.message, 'stack': error.stack, 'type': error.constructor.name }, error.message)\n  }\n\n  _getFormattedIn(target, self, parameter) {\n\n    let className = Is.undefined(self) ? null : self.name || self.constructor.name\n    let methodName = target.name\n\n    // let formatParameterFn = null\n    // formatParameterFn = Is.undefined(self) ? null : self[`_format${PascalCase(methodName)}Parameter`] || null\n    // formatParameterFn = Is.null(formatParameterFn) ? formatParameterFn : formatParameterFn.bind(self)\n\n    let formatParameterFn = target._formatParameter ? target._formatParameter.bind(target, ...parameter) : this._formatParameter.bind(this, parameter)\n    let [ parameterAsObject, parameterAsString ] = formatParameterFn()\n\n    return [ className, methodName, parameterAsObject, parameterAsString ]\n\n  }\n\n  _applyOut(target, self, parameter, duration, returnValue) {\n    let [ className, methodName, parameterAsObject, parameterAsString, returnValueAsObject, returnValueAsString ] = this._getFormattedOut(target, self, parameter, returnValue)\n    this._log.trace({ ...parameterAsObject, ...returnValueAsObject, duration }, `< ${Is.null(className) ? '' : `${className}.`}${methodName}(${parameterAsString})${Is.undefined(returnValue) || Is.emptyString(returnValueAsString) ? '' : ` returned ${returnValueAsString}`}`)\n  }\n\n  _getFormattedOut(target, self, parameter, returnValue) {\n\n    let [ className, methodName, parameterAsObject, parameterAsString ] = this._getFormattedIn(target, self, parameter)\n\n    // let formatReturnValueFn = null\n    // formatReturnValueFn = Is.undefined(self) ? null : self[`_format${PascalCase(methodName)}ReturnValue`] || null\n    // formatReturnValueFn = Is.null(formatReturnValueFn) ? formatReturnValueFn : formatReturnValueFn.bind(self)\n\n    let formatReturnValueFn = target._formatReturnValue ? target._formatReturnValue.bind(target, returnValue) : this._formatReturnValue.bind(this, returnValue)\n    let [ returnValueAsObject, returnValueAsString ] = formatReturnValueFn()\n\n    return [ className, methodName, parameterAsObject, parameterAsString, returnValueAsObject, returnValueAsString ]\n\n  }\n\n  _getDuration([ seconds, nanoseconds ]) {\n    return seconds * NANOSECONDS_PER_SECOND + nanoseconds\n  }\n\n  _formatParameter(parameterAsArray, keyPrefix = 'p') {\n\n    let index = 0\n    let key = null\n\n    let parameterAsObject = {}\n    let parameterAsString = parameterAsArray\n      .map((value) => {\n\n        switch(true) {\n          case Is.null(value):\n            return 'null'\n          case Is.undefined(value):\n            return 'undefined'\n          case Is.primitive(value):\n            return this._formatPrimitive(value)\n          case Is.date(value):\n            return this._formatDateTime(value)\n          case Is.regexp(value):\n            return value.toString()\n          default:\n\n            key = `${keyPrefix}${index++}`\n            parameterAsObject[key] = value\n\n            return key\n\n        }\n\n      })\n      .join(', ')\n\n    return [ parameterAsObject, parameterAsString ]\n\n  }\n\n  _formatReturnValue(returnValue, keyPrefix = 'r') {\n    return this._formatParameter([ returnValue ], keyPrefix)\n  }\n\n  _formatPrimitive(value) {\n    return Utilities.inspect(value)\n  }\n\n  _formatDateTime(value) {\n    return `'${DateTime.fromJSDate(value).toFormat('yyyy.LL.dd-HH:mm:ss.SSSZZZ')}'`\n  }\n\n}\n\nexport { LogHandler }"],"file":"log-handler.js"}