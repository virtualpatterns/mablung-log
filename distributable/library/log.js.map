{"version":3,"sources":["../../source/library/log.js"],"names":["Configuration","Is","Pino","LogDestination","LogHandler","LogParameter","LogAttachedError","LogDetachedError","Process","process","Log","constructor","parameter","userDestination","userOption","getConstructorParameter","destination","option","getOption","defaultOption","pinoDestination","pinoOption","_pinoLog","_createPinoLog","_destination","_option","createDestination","getLevelName","levelNumber","levels","labels","trace","debug","info","warn","error","fatal","attach","_attachOption","handleExit","on","__onExit","onImmediate","immediateLog","detach","handleKillSignal","forEach","signal","count","listenerCount","exit","handleRotate","rotate","off","createProxy","object","Proxy","immediateFn","final","pinoLog","immediateParameter","not","null"],"mappings":"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","sourcesContent":["import { Configuration } from '@virtualpatterns/mablung-configuration'\nimport { Is } from '@virtualpatterns/mablung-is'\nimport Pino from 'pino'\n\nimport { LogDestination } from './log-destination.js'\nimport { LogHandler } from './log-handler.js'\nimport { LogParameter } from './log-parameter.js'\n\nimport { LogAttachedError } from './error/log-attached-error.js'\nimport { LogDetachedError } from './error/log-detached-error.js'\n\nconst Process = process\n\nclass Log {\n\n  constructor(...parameter) {\n\n    let [ userDestination, userOption ] = LogParameter.getConstructorParameter(this, ...parameter)\n  \n    let destination = userDestination\n    let option = Configuration.getOption(this.defaultOption, userOption)\n\n    let pinoDestination = destination instanceof LogDestination ? destination.pinoDestination : destination\n    let pinoOption = option\n\n    this._pinoLog = this._createPinoLog(pinoDestination, pinoOption)\n\n    this._destination = destination\n    this._option = option\n\n  }\n\n  _createPinoLog(destination, option) {\n    return Pino(option, destination)\n  }\n\n  createDestination(...parameter) {\n    return new LogDestination(...parameter)\n  }\n\n  /* c8 ignore next 3 */\n  get destination() {\n    return this._destination\n  }\n\n  get defaultOption() {\n    return {\n      'level': 'info',\n      'nestedKey': 'data'\n    }\n  }\n\n  /* c8 ignore next 3 */\n  get option() {\n    return this._option\n  }\n\n  getLevelName(levelNumber) {\n    return this._pinoLog.levels.labels[levelNumber]\n  }\n\n  trace(...parameter) {\n    return this._pinoLog.trace(...parameter)\n  }\n\n  debug(...parameter) {\n    return this._pinoLog.debug(...parameter)\n  }\n\n  info(...parameter) {\n    return this._pinoLog.info(...parameter)\n  }\n\n  warn(...parameter) {\n    return this._pinoLog.warn(...parameter)\n  }\n\n  error(...parameter) {\n    return this._pinoLog.error(...parameter)\n  }\n\n  fatal(...parameter) {\n    return this._pinoLog.fatal(...parameter)\n  }\n\n  attach(option = { \n    'handleExit': true,\n    'handleKillSignal': [ 'SIGINT', 'SIGTERM' ],\n    'handleRotate': [ 'SIGHUP' ]\n  }) {\n    this.trace({ option }, 'Log.attach(option)')\n\n    if (this._attachOption) {\n      throw new LogAttachedError()\n    } else {\n\n      if (option.handleExit) {\n\n        Process.on('exit', this.__onExit = this.onImmediate((immediateLog) => {\n          immediateLog.trace('Process.on(\\'exit\\', this.__onExit = this.onImmediate((immediateLog) => { ... }))')\n\n          try {\n            this.detach()\n          /* c8 ignore next 3 */\n          } catch (error) {\n            immediateLog.error(error)\n          }\n\n        }))\n\n      }\n\n      if (option.handleKillSignal) {\n\n        option.handleKillSignal.forEach((signal) => {\n          Process.on(signal, this[`__on${signal}`] = this.onImmediate((immediateLog) => {\n            immediateLog.trace(`Process.on('${signal}', this.__on${signal} = this.onImmediate((immediateLog) => { ... }))`)\n\n            try {\n              this.detach()\n            /* c8 ignore next 3 */\n            } catch (error) {\n              immediateLog.error(error)\n            }\n    \n            let count = Process.listenerCount(signal)\n\n            /* c8 ignore next 5 */\n            if (count <= 0) {\n              Process.exit()\n            } else {\n              immediateLog.trace(`Process.listenerCount('${signal}') returned ${count}`)\n            }\n\n          }))\n        })\n\n      }\n\n      if (option.handleRotate) {\n\n        option.handleRotate.forEach((signal) => {\n          Process.on(signal, this[`__on${signal}`] = () => {\n            this.trace(`Process.on('${signal}', this.__on${signal} = () => { ... })`)\n\n            try {\n              this.rotate()\n            /* c8 ignore next 3 */\n            } catch (error) {\n              this.error(error)\n            }\n\n          })\n        })\n\n      }\n\n      this._attachOption = option\n\n    }\n\n  }\n\n  detach() {\n    this.trace('Log.detach()')\n\n    if (this._attachOption) {\n\n      let option = this._attachOption\n\n      if (option.handleExit && \n          this.__onExit) {\n        Process.off('exit', this.__onExit)\n        delete this.__onExit\n      }\n\n      if (option.handleKillSignal) {\n  \n        option.handleKillSignal.forEach((signal) => {\n          if (this[`__on${signal}`]) {\n            Process.off(signal, this[`__on${signal}`])\n            delete this[`__on${signal}`]\n          }\n        })\n\n      }\n\n      if (option.handleRotate) {\n\n        option.handleRotate.forEach((signal) => {\n          if (this[`__on${signal}`]) {\n            Process.off(signal, this[`__on${signal}`])\n            delete this[`__on${signal}`]\n          }\n        })\n\n      }\n\n      delete this._attachOption\n        \n    } else {\n      throw new LogDetachedError()\n    }\n\n  }\n\n  rotate() {\n    this._destination.rotate()\n  }\n\n  createProxy(object) {\n    return new Proxy(object, new LogHandler(this))\n  }\n\n  onImmediate(immediateFn) {\n\n    return Pino.final(this._pinoLog, (error, pinoLog, ...parameter) => {\n\n      let immediateLog = null\n      immediateLog = new this.constructor(this._destination, this._option)\n      immediateLog._pinoLog = pinoLog\n\n      let immediateParameter = Is.not.null(error) ? [error, ...parameter] : parameter\n\n      immediateFn(immediateLog, ...immediateParameter)\n\n    })\n\n  }\n\n}\n\nexport { Log }\n"],"file":"log.js"}